/*! jquery-ui-multisearch: jQuery UI MultiSearch (v0.0.4 built 2016-10-28)
* https://github.com/bseth99/jquery-ui-multisearch
* Copyright 2016 Ben Olson;  Licensed MIT 
*/
(function(t,e){"function"==typeof define&&define.amd?define(["jquery","underscore"],e):t.$=e(t.$,t._)})(this,function(t,e){"use strict";function i(t){return t.replace(s,"\\$&")}var s=RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g");return t.widget("osb.multisearch",{optionData:null,optionIndex:-1,itemData:null,itemIndex:-1,localCache:null,options:{showOnEmpty:!1,filterAddedItems:!1,source:null,ajaxOptions:null,keyAttrs:null,searchAttrs:null,formatPickerItem:function(t){return'<li><a href="#">'+t.name+"</a></li>"},formatSelectedItem:function(t){return'<a href="#">'+t.name+"</a>"},buildNewItem:function(t){return{id:null,name:t}},minSearchChars:2,searchThrottle:200,maxShowOptions:5,minLocalCache:50,preventNotFound:!1,preventDuplicates:!0,useAutoWidth:!0,pickerPosition:{my:"left top",at:"left bottom"},inputPosition:"end",localMatcher:function(t,e){return e.toLowerCase().indexOf(t.toLowerCase())>-1}},value:function(t){var i=this;return t?(this.remove(),e.each(t,function(t){i.add(t)}),void 0):e.map(this.itemData,function(t){return e.clone(t)})},add:function(t,e){var i,s={silent:!0};e!==void 0&&(s.at=e),(i=this._findByKeys(t))>-1&&(this._removeItem(i),(s.at===void 0||null===s.at)&&(s.at=i)),this._addItem(t,s)},remove:function(t){var i;0===arguments.length?(this._getSelectedChildren().remove(),this.itemData=[],this.itemIndex=-1):e.isObject(t)?(i=this._findByKeys(t))>-1&&this._removeItem(i,{silent:!0}):this._removeItem(t,{silent:!0})},_findByKeys:function(t){var i,s,n=this.options.keyAttrs,r=-1;return i=e.values(e.pick(t,n)),i.length==n.length&&(s=e.findWhere(this.itemData,e.object(n,i)),s&&(r=e.indexOf(this.itemData,s))),r},_findByKeysInOptionData:function(t){var i,s,n=this.options.keyAttrs,r=-1;return i=e.values(e.pick(t,n)),i.length==n.length&&(s=e.findWhere(this.optionData,e.object(n,i)),s&&(r=e.indexOf(this.optionData,s))),r},_create:function(){var e=this.options;e.keyAttrs=e.keyAttrs||["id"],e.searchAttrs=e.searchAttrs||["name"],this.localCache={},this.optionData=[],this.itemData=[],this.search_text="",this.element.addClass("osb-multisearch"),this.$input=this.element.find('[data-role="input"]').attr({autocomplete:"off",autocapitalize:"off",spellcheck:"false"}),this.$picker=this.element.find('[data-role="picker"]').css("position","absolute").hide(),this.$pickerList=this.element.find('[data-role="picker-list"]'),this.$itemList=this.element.find('[data-role="selected-list"]'),this.$input.on("keydown.multisearch",t.proxy(this,"_processInput")),this.$input.on("focus.multisearch",t.proxy(this,"_checkEmpty")),this.$picker.on("click.multisearch mouseenter.multisearch mouseleave.multisearch",'[data-role="picker-item"]',t.proxy(this,"_processPicker")),this.$itemList.on("click.multisearch mouseenter.multisearch mouseleave keydown.multisearch",'[data-role="selected-item"]',t.proxy(this,"_processSelected")),this._initAutoWidth(),this._initRemote();var i=this;t(document).on("click.multisearch",function(t){0===i.element.has(t.target).length&&i._hidePicker()})},_initRemote:function(){var i=this,s=this.options,n=function(t,e){i._trigger("searched",null,{term:t,picker:i.$picker,list:e}),i.localCache[t]=e,i.optionData=e.slice(0,s.maxShowOptions),i._renderPickerItems()};"string"==typeof s.source?(s.ajaxOptions=s.ajaxOptions||{searchTerm:"term",dataType:"json",method:"GET"},this._remoteSearch=e.throttle(function(){i.localCache[i.search_text]?n(i.search_text,i.localCache[i.search_text]):(i._xhr&&i._xhr.abort(),i._xhr=t.ajax({url:s.source,data:s.ajaxOptions.searchTerm+"="+i.search_text,dataType:s.ajaxOptions.dataType,method:s.ajaxOptions.method}).done(e.partial(n,i.search_text)))},s.searchThrottle,{leading:!1})):this._remoteSearch=t.isFunction(s.source)?e.throttle(function(){i.localCache[i.search_text]?n(i.search_text,i.localCache[i.search_text]):s.source.call(i,i.search_text,e.partial(n,i.search_text))},s.searchThrottle,{leading:!1}):function(){var t=e.filter(s.source,function(t){return i._matcher.call(i,t)});i.optionData=t.slice(0,s.maxShowOptions),i._renderPickerItems()}},_initAutoWidth:function(){this.options.useAutoWidth&&(this.$sizer=t("<div></div>").css({position:"absolute",top:-9999,left:-9999,width:"100%",fontSize:this.$input.css("font-size"),fontFamily:this.$input.css("font-family"),fontWeight:this.$input.css("font-weight"),letterSpacing:this.$input.css("letter-spacing"),paddingLeft:this.$input.css("padding-left"),paddingRight:this.$input.css("padding-right"),marginLeft:this.$input.css("margin-left"),marginRight:this.$input.css("margin-right"),whiteSpace:"nowrap"}).insertAfter(this.$input),this.$input.on("keyup",t.proxy(this,"_autoSizeInput")))},_destroy:function(){this.element.removeClass("osb-multisearch"),t(document).off(".multisearch"),this.$input.off(".multisearch"),this.$picker.off(".multisearch"),this.$itemList.off(".multisearch"),this.$sizer.remove(),this.$pickerList.html(""),this._getSelectedChildren().remove(),this.$picker.show(),this._remoteSearch=null,this.localCache=null,this.optionData=null,this.itemData=null},_checkEmpty:function(){var i=this.options;0===this.$input.val().length&&i.showOnEmpty&&e.defer(t.proxy(this,"_search"))},_processInput:function(i){var s=this.options;switch(i.keyCode){case jQuery.ui.keyCode.UP:case jQuery.ui.keyCode.DOWN:case jQuery.ui.keyCode.LEFT:case jQuery.ui.keyCode.RIGHT:return this.$input.val().length?(i.keyCode===jQuery.ui.keyCode.DOWN||i.keyCode===jQuery.ui.keyCode.RIGHT?this.optionIndex<this.options.maxShowOptions-1&&this._overPickerItem(this._getPickerChildren().eq(++this.optionIndex)):this.optionIndex>0&&this._offPickerItem(this._getPickerChildren().eq(--this.optionIndex)),!1):(i.keyCode===jQuery.ui.keyCode.DOWN||i.keyCode===jQuery.ui.keyCode.RIGHT?this._gotoPrevItem():this._gotoNextItem(),!1);case jQuery.ui.keyCode.SPACE:if(!this.$input.val().length)return this.itemIndex>-1&&this.itemIndex<this.itemData.length?this._getSelectedChildren().eq(this.itemIndex).trigger("click"):this._clearSelectedItem(),!1;break;case jQuery.ui.keyCode.DELETE:if(!this.$input.val().length){if(this.itemIndex>-1&&this.itemIndex<this.itemData.length){var n=jQuery.Event("keydown");n.keyCode=jQuery.ui.keyCode.DELETE,this._getSelectedChildren().eq(this.itemIndex).trigger(n)}return!1}1===this.$input.val().length&&s.showOnEmpty&&e.defer(t.proxy(this,"_search"));break;case jQuery.ui.keyCode.BACKSPACE:if(!this.$input.val().length)return"end"==this.options.inputPosition&&this.itemData.length>0&&(this.itemIndex>-1&&this.itemIndex<this.itemData.length?this._removeSelectedItem():(this.itemIndex=this.itemData.length-1,this._getSelectedChildren().eq(this.itemIndex).trigger("mouseenter")),this._hidePicker()),!1;1===this.$input.val().length?s.showOnEmpty?e.defer(t.proxy(this,"_search")):this._hidePicker():e.defer(t.proxy(this,"_search"));break;case jQuery.ui.keyCode.TAB:case jQuery.ui.keyCode.ENTER:if(this.search_text.length>0)return this.optionIndex>-1?this._addSelectedItem():this.options.preventNotFound||this._addItem(this.options.buildNewItem(this.search_text)),this._clearSelectedItem(),i.stopPropagation(),i.preventDefault(),!1;break;case jQuery.ui.keyCode.ESCAPE:return this._hidePicker(),this.optionIndex=-1,!0;default:String.fromCharCode(i.which)&&(this._clearSelectedItem(),e.defer(t.proxy(this,"_search")))}},_processPicker:function(e){var i=t(e.currentTarget);switch(e.type){case"click":this.optionIndex=this._getPickerChildren().index(i),this._addSelectedItem(),this.$input.focus();break;case"mouseenter":this._overPickerItem(i);break;case"mouseleave":this._offPickerItem(i)}},_processSelected:function(e){var i,s=t(e.target),n=t(e.currentTarget);switch(e.type){case"click":if(this.itemIndex=this._getSelectedChildren().index(n),this._activeSelectedItem(n),s.is("[data-action]")||(s=s.parents("[data-action]").first()),s.length&&n.has(s).length){if(i=s.attr("data-action"),this._trigger("itemaction",null,{action:i,data:this.itemData[this.itemIndex],element:n}))switch(i){case"remove":var r=jQuery.Event("keydown");return r.keyCode=jQuery.ui.keyCode.DELETE,n.trigger(r),e.stopPropagation(),e.preventDefault(),!1}}else this._trigger("itemselect",null,{data:this.itemData[this.itemIndex],element:n});break;case"mouseenter":this._overSelectedItem(n);break;case"mouseleave":this._offSelectedItem(n);break;case"keydown":switch(e.keyCode){case jQuery.ui.keyCode.UP:case jQuery.ui.keyCode.DOWN:case jQuery.ui.keyCode.LEFT:case jQuery.ui.keyCode.RIGHT:return e.keyCode===jQuery.ui.keyCode.DOWN||e.keyCode===jQuery.ui.keyCode.RIGHT?this._gotoPrevItem():this._gotoNextItem(),!1;case jQuery.ui.keyCode.SPACE:return this.itemIndex>-1&&this.itemIndex<this.itemData.length&&this._getSelectedChildren().eq(this.itemIndex).trigger("click"),!1;case jQuery.ui.keyCode.BACKSPACE:case jQuery.ui.keyCode.DELETE:return this.itemIndex>-1&&this.itemIndex<this.itemData.length&&(this._removeSelectedItem(),this.$input.focus()),e.stopPropagation(),e.preventDefault(),!1}}},_addSelectedItem:function(){var t=this.options.filterAddedItems?this._getFilteredList():this.optionData,i=t[this.optionIndex];this._addItem(e.clone(i)),this.optionIndex=-1},_addItem:function(i,s){var n,r,h=s||{},o=this.options.inputPosition,a=!0,c=!1,l=h.silent||!1,d=null===h.at||h.at===void 0?"start"==o?0:this.itemData.length:h.at,u=this.options.keyAttrs;i&&(c=!e.values(e.pick(i,u)).join("").length,!c&&this.options.preventDuplicates&&(a=-1==(n=this._findByKeys(i)),a||this._trigger("duplicate",null,{existing:this.itemData[n],adding:i})),a&&(l||this._trigger("adding",null,{data:i,notfound:c}))&&(r=t(this.options.formatSelectedItem(i)).attr({"data-role":"selected-item",tabIndex:-1}),d==this.itemData.length?(this.$itemList.has(this.$input).length>0?"start"==o?r.insertAfter(this.$input):r.insertBefore(this.$input):this.$itemList.append(r),this.itemData.push(i)):(r.insertBefore(this._getSelectedChildren().eq(d)),this.itemData.splice(d,0,i)),this.$input.val(""),this.search_text="",this._hidePicker(),-1==this.itemIndex||this.itemIndex==this.itemData.length-1?this._gotoFirstItem():this.itemIndex>=d&&this.itemIndex++,l||this._trigger("added",null,{data:i,element:r,notfound:c})))},_removeSelectedItem:function(){this._removeItem(this.itemIndex)},_removeItem:function(t,e){var i=e||{},s=i.silent||!1,n=this.itemData[t];n&&(s||this._trigger("removing",null,{data:n}))&&(this._getSelectedChildren().eq(t).remove(),this.itemData.splice(t,1),this.itemData.length>0&&(this.itemIndex>t&&this.itemIndex--,this.itemIndex>-1&&this.itemIndex<this.itemData.length&&this._overSelectedItem(this._getSelectedChildren().eq(this.itemIndex))),s||this._trigger("removed",null,{data:n}))},_getSelectedChildren:function(){return this.$itemList.children('[data-role="selected-item"]')},_clearSelectedItem:function(){this.$itemList.children().removeClass("active hover"),this._gotoFirstItem()},_activeSelectedItem:function(t){this._trigger("selectedactive",null,{target:t,siblings:t.siblings('[data-role="selected-item"]')})&&t.addClass("active").siblings('[data-role="selected-item"]').removeClass("active")},_overSelectedItem:function(t){this._trigger("selectedhoverin",null,{target:t,siblings:t.siblings('[data-role="selected-item"]')})&&t.addClass("hover").siblings('[data-role="selected-item"]').removeClass("hover")},_offSelectedItem:function(t){this._trigger("selectedhoverout",null,{target:t,siblings:t.siblings('[data-role="selected-item"]')})&&(t.removeClass("hover"),this.itemIndex>-1&&this._overSelectedItem(this._getSelectedChildren().eq(this.itemIndex)))},_gotoPrevItem:function(){this.itemIndex<this.itemData.length-1?this.$itemList.children().not(this.$input).eq(++this.itemIndex).trigger("mouseenter"):this.itemIndex==this.itemData.length-1&&(this.itemIndex++,this.$itemList.children().removeClass("hover"))},_gotoNextItem:function(){this.itemIndex>0?this.$itemList.children().not(this.$input).eq(--this.itemIndex).trigger("mouseenter"):0===this.itemIndex&&(this.itemIndex--,this.$itemList.children().removeClass("hover"))},_gotoFirstItem:function(){this.itemIndex="start"==this.options.inputPosition?-1:this.itemData.length},_renderPickerItems:function(){var i=this;this.$pickerList.html(""),this.optionIndex=-1;var s=this.options.filterAddedItems?this._getFilteredList():this.optionData;e.each(s,function(e){i.$pickerList.append(t(i.options.formatPickerItem(i._formatter(e))).attr("data-role","picker-item"))}),s.length>0?(this._showPicker(),(this.options.preventNotFound||1==s.length)&&(this.optionIndex=0,this._overPickerItem(this._getPickerChildren().eq(0)))):this._hidePicker()},_showPicker:function(){this.$picker.show(),this.$picker.position({my:this.options.pickerPosition.my,at:this.options.pickerPosition.at,of:this.$input})},_hidePicker:function(){this.$picker.hide()},_getPickerChildren:function(){return this.$pickerList.children('[data-role="picker-item"]')},_overPickerItem:function(t){this._trigger("pickerhoverin",null,{target:t,siblings:t.siblings('[data-role="picker-item"]')})&&t.addClass("hover").siblings('[data-role="picker-item"]').removeClass("hover")},_offPickerItem:function(t){this._trigger("pickerhoverout",null,{target:t,siblings:t.siblings('[data-role="picker-item"]')})&&(t.removeClass("hover"),this.optionIndex>-1&&this._overPickerItem(this._getPickerChildren().eq(this.optionIndex)))},_formatter:function(t){var s=this,n=this.search_text,r=e.clone(t);return n.length>0&&e.each(this.options.searchAttrs,function(t){r[t]&&s.options.localMatcher(n,r[t])&&(r[t]=r[t].replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+i(n)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"))}),r},_matcher:function(t){var i=this;return 0===this.search_text.length||this.search_text.length>0&&e.any(e.values(e.pick(t,i.options.searchAttrs)),function(t){return i.options.localMatcher(i.search_text,t)})},_search:function(){var t,i,s=this;i=this.search_text=this.$input.val(),this.search_text.length<this.options.minSearchChars||(i=i.length>1?i.slice(0,i.length-1):null,i&&this.localCache[i]&&this.localCache[i].length<=this.options.minLocalCache?(t=e.filter(this.localCache[i],function(t){return s._matcher.call(s,t)}),this.localCache[this.search_text]=t,this.optionData=t.slice(0,this.options.maxShowOptions),this._renderPickerItems()):(this._showPicker(),this._trigger("searching",null,{term:this.search_text,picker:this.$picker}),this._remoteSearch()))},_autoSizeInput:function(){var t=this.$input.val(),e=this.maxInputWidth;this.maxInputWidth||(this.maxInputWidth=this.$sizer.width(),this.$sizer.css("width","auto")),this.$sizer.html((i(t)||i(this.$input.attr("placeholder"))||"MMMMMMMMMMMMMMMM").replace(/ /g,"&nbsp;")),this.$input.css({width:Math.min(100,Math.ceil(100*(Math.max(this.minInputWidth,this.$sizer.outerWidth(!0)+25)/e)))+"%"}),this.minInputWidth||(this.minInputWidth=this.$input.width())},_getFilteredList:function(){var t,i=[],s=this;return e.each(this.optionData,function(e){t=s._findByKeys(e),0>t&&i.push(e)}),i}}),t});